<!--components/business/Image/image.wxml-->
<wxs module='urlFix'>
    var getSrc = function (src, useWebp, width, pixelRatio) {
        var _format = _getExt(src, useWebp)
        var _width = ""
        var _service_w = ""
        var _unit = ""
        var _script = ""
        _service_w = ((src.split('w=')[1]) || '').split('&h=')[0] || ''
        if(_service_w) {
            _script = "thumbnail/" + _service_w + "x/"
        }
        if(width) {
            width = width  + ''
            _width = width.match("\d+", "g")
            _unit = width.match("[a-z|A-Z]+", "g")
            if((_unit && _unit[0] && _unit[0].toLowerCase() === "px") || !_unit) {
                _width = pixelRatio >= 2 ? _width * 2 : _width * pixelRatio
                _width = (_service_w && _service_w < _width) ? _service_w : _width

            }
            _script = "thumbnail/" + _width + "x/"
        }
        if(src.indexOf('/service') === -1){
            src = src.replace(
                'image.yonghuivip.com//', 
                'image.yonghuivip.com/'
            ).split('?')[0]
            + "?imageMogr2/auto-orient/" 
            + _script 
            + "strip/format/" 
            + _format 
            + "/interlace/1/quality/95/size-limit/300k!"
        }
        return src
    }
    var getLength = function(value) {
        if(!value) return ""
        value = (value || '') + ''
        var _length = ""
        var _unit = ""
        _length = value.match("\d+", "g")
        _unit = value.match("[a-z|A-Z]+", "g")

        if((_unit && _unit[0] && _unit[0].toLowerCase() === "px") || !_unit) {
            _length = _length * 2
        }
        return _length
    }
    var _getExt = function(src, useWebp) {
        var fileUrl = src.split('?')[0]
        var splitUlr = fileUrl.split('/')
        var filepath = splitUlr[splitUlr.length - 1]
        var format = filepath.split('.')[1] || 'jpg'
        return 'webp'
    }

    var getStyle = function(bgImg, width, height, style, radius) {
        var _radius = ""
        var b = bgImg ? "background-image: url('" + bgImg + "');" : ''
        var w = width ? 'width:' + getLength(width) + 'rpx;' : ''
        var h = height ? 'height:' + getLength(height) + 'rpx;' : 'min-height:1px;'
        var s = style + ';'
        var _s = ''
        if(radius && radius.length === 1) {
            _radius = radius[0] + 'rpx'
        }
        if(radius && radius.length === 4) {
            for(var i = 0; i < radius.length; i++) {
                _radius += radius[i] + "rpx "
            }
        }
        if(_radius) r = ";border-radius: " + _radius
        return b + w + h + _s + r + ';'
    }

    var getClass = function(hideMini) {
        return hideMini ? 'oak-image-load' : ''
    }

    module.exports = {
        getSrc: getSrc,
        getStyle: getStyle,
        getClass: getClass,
    }
</wxs>
<view 
    class="oak-image class ext-class {{urlFix.getClass(hideMini)}}" 
    style="{{urlFix.getStyle(bgImg, width, height, style, radius)}}">
    <image 
        wx:if="{{src}}"
        class="origin-image img-class" 
        lazy-load="{{ lazyLoad }}" 
        mode="{{ mode }}" 
        webp="{{ webp }}"
        src="{{ urlFix.getSrc(src, useWebp, width, pixelRatio)}}" 
        binderror="onLoadError" 
        bindload="onLoad"
        bindtap="clickImg"
        style="border-radius:{{imgRadius ? imgRadius : ''}}"
    ></image>
</view>

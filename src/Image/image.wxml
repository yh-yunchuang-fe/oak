<!-- 
    https://image.yonghuivip.com/image/16303891639179b6d5ba3ae7908c8fa574c8d6b4347cac4ee0a2a.jpg
    ?imageMogr2/auto-orient/strip/interlace/1/quality/95/size-limit/300k!
    |roundPic/radius/24
    |imageMogr2/format/webp
-->
<wxs src="../wxs/base.wxs" module="Utils" />
<wxs module='ws'>
    function getSrc (src, useWebp, width, pixelRatio, quality, radius) {
        if (src.indexOf('/service') > -1) return src

        width = width ? width + '' : width

        var baseUrl = src
            .replace('http://image.yonghuivip.com', 'https://image.yonghuivip.com')
            .replace('image.yonghuivip.com//', 'image.yonghuivip.com/')
            .split('?')[0] + '?'
            
        var thumbnail = width.match("\d+", "g") || ""
            , format = _getExt(src, useWebp)
            , service_w = (src.match("w=(\d+)") || [])[1] || ''
            , widthScript = "imageMogr2/auto-orient"
            , qualityScript = "/interlace/1/quality/" + quality + "/size-limit/300k!"
            , radiusScript = "|roundPic/radius/"
            , formatScript = "|imageMogr2/format/" + format
            ;

        if (hasUnit(width.toLowerCase(), 'px')) {
            thumbnail = pixelRatio >= 2 ? thumbnail * 2 : thumbnail * pixelRatio
            thumbnail = (service_w && service_w < thumbnail) ? service_w : thumbnail
        }

        if(width || service_w) {
            widthScript += "/thumbnail/" + (width ? thumbnail : service_w) + "x"
        }

        var imgRadius = getImgRadius(radius)
        if (!imgRadius) {
            return baseUrl + widthScript + qualityScript + formatScript
        }

        var radius = imgRadius.match("\d+", "g")
        
        if (hasUnit(imgRadius.toLowerCase(), 'rpx')) radius = radius / 2

        radius = pixelRatio >= 2 ? radius * 2 : radius * pixelRatio
        if(!radius) {
            return baseUrl + widthScript + qualityScript + formatScript
        }

        radiusScript += radius

        return baseUrl + 'imageMogr2/format/png|'
            + widthScript 
            + qualityScript 
            + radiusScript 
            + formatScript
    }

    function getRadius(radius){
        if(!radius) return ''
        radius = "Array" === radius.constructor ? radius : radius.split(' ')
        radius =  radius.reduce(function(acc,item){
            item = (item + '').trim();
            if(item){
                if(item.indexOf('px') === -1){
                    item += 'rpx'
                }
                acc.push(item)
            }
            return acc
        },[])
        return radius.join(' ')
    }

    function getImgRadius(imgRadius) {
        imgRadius = getRadius(imgRadius)
        if(imgRadius.split(' ').length !== 1){
            return ''
        }
        return imgRadius
    }


    function hasUnit(size, unit) {
        if (!size) return false
        if (!size.match("[a-z|A-Z]+", "g") && unit === "px") return true

        return getRegExp("^\d+" + unit + "+$", 'g').test(size.toLowerCase())
    }

    function getLength(value) {
        if (!value) return ""
        
        value = value + ''

        var length = value.match("\d+", "g")

        if (hasUnit(value.toLowerCase(), 'px')) length = length * 2

        return length
    }

    function _getExt(src, useWebp) {
        var fileUrl = src.split('?')[0]
        var splitUlr = fileUrl.split('/')
        var filepath = splitUlr[splitUlr.length - 1]
        var format = filepath.split('.')[1] || 'jpg'

        return 'webp'
    }

    function getSize(size){
        if(!size) return ''

        if(hasUnit(size, '%')) return size + ';'

        return getLength(size) + 'rpx;'
    }

    function getStyle(bgImg, width, height, radius, noBgImg, bgColor) {
        var b = bgImg && !noBgImg ? "background-image: url('" + bgImg + "');" : ''
        var w = width ? 'width:' + getSize(width) : ''
        var h = height ? 'height:' + getSize(height) : 'min-height:1px;'
        var bgColor = bgColor ? 'background-color:' + bgColor + ';' : ''
        
        var r =  getRadius(radius)
        if (r) r = ";border-radius: " + r + ';'
        return b + w + h + r + bgColor
    }

    function split(str, separator, howmany) {
        return (str && str.split(separator, howmany)) || []
    }

    module.exports = {
        getSrc: getSrc,
        getStyle: getStyle,
        getImgRadius: getImgRadius,
        split: split,
    }
</wxs>

<view id="image-wrap" 
    class="oak-image class ext-class {{Utils.classNames({noBgCOlor: !bgColor, loaded: status == 1, error: status == 2})}} " 
    style="{{ws.getStyle(bgImg, width, height, radius, noBgImg, bgColor)}}"
>
    <oak-loading is-show="{{!status}}"
        loader-class="loader"
        position="absolute"
    />
    <image wx:if="{{src}}"
        class="origin-image img-class"
        src="{{ws.getSrc(src, useWebp, width, pixelRatio, quality, imgRadius)}}" 
        style="{{ws.getImgRadius(imgRadius)? 'border-radius:' + ws.getImgRadius(imgRadius) : ''}}"
        mode="{{mode}}"
        webp="{{webp}}"
        lazy-load="{{lazyLoad}}"
        data-src="{{src}}"
        bindload="onLoad"
        binderror="onError"
    />
    <slot></slot>
</view>
